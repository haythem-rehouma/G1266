# ARRÊT COMPLET DU PROJET **mlops-redwine**

*(et préparation à une pipeline CI/CD GitHub Actions → Docker Hub → VM)*

> **Important :** chaque étape est numérotée et **autonome**.
> Copiez‑collez exactement les commandes. Rien n’est laissé à deviner.

---

## PARTIE A – ÉTEINDRE PROPREMENT LE STACK DOCKER

### 1. Se connecter à la VM

```bash
ssh -i key.pem azureuser@IP_PUBLIQUE
```

### 2. Aller dans le dossier du projet

```bash
cd /home/azureuser/mlops-redwine
pwd        # DOIT afficher /home/azureuser/mlops-redwine
```

### 3. Arrêter les conteneurs en conservant les volumes

```bash
docker-compose down
```

### 4. (Facultatif) Supprimer aussi les volumes **pour tout remettre à zéro**

```bash
docker-compose down -v      # efface mlruns + PostgreSQL + pgAdmin
```

### 5. Vérifier qu’il ne reste plus de conteneurs

```bash
docker ps -a                # ne doit rien afficher lié à mlops-redwine
```

### 6. Nettoyer les images et couches inutiles (optionnel mais recommandé)

```bash
docker system prune -af --volumes
```

> **Le projet est maintenant totalement éteint.**
> Vous pouvez fermer la session SSH (`exit`).

---

## PARTIE B – MISE EN PLACE D’UNE PIPELINE CI/CD

### ╔════════════════════════════════ ASCII : Vue d’ensemble ═══════════════════════════════╗

```
 Développeur ──push──▶ GitHub Repo ──GitHub Actions──▶ Docker Hub ──pull──▶ VM Azure
    |                                 (build &                                    │
    └─────────────── SSH ───────────── push) ◀─────────── webhooks ────────────────┘
```

╚════════════════════════════════════════════════════════════════════════════════════════╝

### 1. Prérequis comptes

1.1 Créez (ou utilisez) un compte **GitHub**.
1.2 Créez (ou utilisez) un compte **Docker Hub**. Retenez :
    – *NAMESPACE* : `votre_dockerhub`
    – *REPOSITORY* : `mlops-redwine`

### 2. Initialiser le dépôt Git local

```bash
cd /home/azureuser/mlops-redwine
git init
git add .
git commit -m "Initial commit – stack MLOps"
git branch -M main
git remote add origin https://github.com/<votre_user>/mlops-redwine.git
git push -u origin main
```

*(remplacez `<votre_user>` par votre pseudo GitHub)*

### 3. Créer les **secrets** GitHub nécessaires

Dans **GitHub → Settings → Secrets → Actions** :

| Nom du secret        | Valeur                                               |
| -------------------- | ---------------------------------------------------- |
| `DOCKERHUB_USERNAME` | votre identifiant Docker Hub                         |
| `DOCKERHUB_PASSWORD` | un **Access Token** Docker Hub (pas le mot de passe) |
| `SSH_HOST`           | IP publique de la VM                                 |
| `SSH_USER`           | `azureuser`                                          |
| `SSH_KEY`            | contenu de `key.pem` (clé privée)                    |

> Pour créer l’Access Token : Docker Hub ► **Account Settings** ► **Security** ► **New Access Token** (scopes : `Write`).

### 4. Ajouter le workflow GitHub Actions

Créez `.github/workflows/ci-cd.yml` :

```yaml
name: CI‑CD Docker

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-redwine:${{ steps.vars.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Pull & restart on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/azureuser/mlops-redwine
            docker-compose down
            docker-compose pull
            docker-compose up -d
```

### 5. Committer le workflow

```bash
git add .github/workflows/ci-cd.yml
git commit -m "feat: pipeline CI/CD GitHub Actions → Docker Hub → VM"
git push
```

### 6. Observer la pipeline

* GitHub → **Actions** : le job `CI‑CD Docker` doit passer vert.
* Docker Hub : nouvelle image `mlops-redwine:<hash>` apparaît.
* VM Azure : `docker ps` montre des conteneurs redémarrés avec la nouvelle image.

---

## RÉCAPITULATIF DES COMMANDES « COPIER‑COLLER » POUR LES ÉTUDIANTS

### Arrêt simple

```bash
cd /home/azureuser/mlops-redwine
docker-compose down
```

### Arrêt + reset complet

```bash
cd /home/azureuser/mlops-redwine
docker-compose down -v
docker system prune -af --volumes
```

### Redémarrage après déploiement CI/CD

```bash
cd /home/azureuser/mlops-redwine
docker-compose pull
docker-compose up -d
```

---

## CONTRÔLE FINAL

1. **Streamlit** : `http://IP_VM:8501` répond.
2. **MLflow** : `http://IP_VM:5000` affiche les expériences.
3. **API** :

```bash
curl http://IP_VM:8000/docs   # Swagger interactif
```

4. **Pipeline** : chaque `git push` lance automatiquement : build → push image → redéploiement VM.

> Votre stack est **éteignable** en deux lignes, **redéployable** en un push, et entièrement pilotable depuis Streamlit.



# Annexe - GUIDE PAS‑À‑PAS – **CRÉER LES SECRETS GitHub Actions**



## 1. CONTEXTE RAPIDE

| Secret               | Pourquoi il est nécessaire                                    |
| -------------------- | ------------------------------------------------------------- |
| `DOCKERHUB_USERNAME` | Pour que GitHub pousse l’image dans **Docker Hub**            |
| `DOCKERHUB_PASSWORD` | (token) — authentifie le push                                 |
| `SSH_HOST`           | Adresse IP de la VM pour déployer                             |
| `SSH_USER`           | Nom d’utilisateur SSH (ex. `azureuser`)                       |
| `SSH_KEY`            | **Contenu texte** de la clé privée `key.pem` (format OpenSSH) |

> Les secrets sont « cachés » : personne ne pourra les lire dans les logs GitHub Actions.

---

## 2. ARBORESCENCE DU PROJET (côté VM / Git)

```
mlops-redwine/
├── .github/
│   └── workflows/
│       └── ci-cd.yml          # pipeline Actions
├── api_app.py                 # FastAPI
├── streamlit_app.py           # Streamlit
├── train_model.py             # script d'entraînement
├── Dockerfile
├── requirements.txt
├── docker-compose.yml
├── data/
│   └── red-wine-quality.csv
└── mlruns/                    # ignoré par Git (.gitignore)
```

**Tous** ces fichiers doivent être déjà dans le dépôt avant de configurer les secrets.

---

## 3. CRÉER UN ACCESS TOKEN **Docker Hub** (1 minute)

1. Connecte‑toi à [https://hub.docker.com](https://hub.docker.com).
2. Avatar ▸ **Account Settings**.
3. Menu gauche : **Security**.
4. Bouton **New Access Token**.
5. Donne un nom : `gh-actions`.
6. Sélectionne **Access permissions : Write**.
7. **Generate** → copie le texte affiché **une seule fois** (ex. `ghp_xyz...`).

*Garde‑le en mémoire temporaire, on va le coller dans GitHub à l’étape 4.3.*

---

## 4. AJOUTER LES SECRETS DANS GITHUB (interface web)

### 4.1 Ouvrir les paramètres

1. Va sur la page GitHub du dépôt `mlops-redwine`.
2. Clique **Settings** (onglet en haut).

### 4.2 Accéder à la section Actions / Secrets

1. Colonne gauche : **Secrets and variables**
2. Sous‑menu : **Actions**
3. Clique **New repository secret** (bouton vert).

### 4.3 Créer chaque secret **un par un**

| Clique « Name » puis « Value » | Exemple de valeur à coller                                                                              |
| ------------------------------ | ------------------------------------------------------------------------------------------------------- |
| `DOCKERHUB_USERNAME`           | **ton identifiant** Docker Hub (ex. `monlogin`)                                                         |
| `DOCKERHUB_PASSWORD`           | **token** copié à l’étape 3                                                                             |
| `SSH_HOST`                     | IP publique de la VM (ex. `20.123.45.67`)                                                               |
| `SSH_USER`                     | `azureuser`                                                                                             |
| `SSH_KEY`                      | **tout le contenu** de `key.pem` (y compris `-----BEGIN OPENSSH PRIVATE KEY-----` et `-----END …-----`) |

> Pour `SSH_KEY` :
>
> * Ouvre `key.pem` avec `cat key.pem` ou un éditeur local.
> * Copie **tout** le bloc texte, colle‑le dans la zone « Value ».
> * Clique **Add secret** à chaque fois.

**Répète** 5 fois jusqu’à voir la liste complète des cinq secrets créés.

---

## 5. FICHIERS CI/CD (à commit si pas déjà faits)

### 5.1 Répertoire et workflow

```bash
cd mlops-redwine
mkdir -p .github/workflows
nano .github/workflows/ci-cd.yml
```

Colle le contenu suivant :

```yaml
name: CI‑CD Docker

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-redwine:${{ steps.vars.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/azureuser/mlops-redwine
            docker-compose pull
            docker-compose up -d
```

Enregistre puis ferme (`CTRL+O`, `Enter`, `CTRL+X`).

### 5.2 Commit + push

```bash
git add .github/workflows/ci-cd.yml
git commit -m "chore: add GitHub Actions CI/CD workflow"
git push
```

---

## 6. VÉRIFIER LA PIPELINE

1. GitHub ▸ onglet **Actions** → workflow « CI‑CD Docker ».
2. Observe les deux jobs :

   * **build-and-push** (image envoyée sur Docker Hub)
   * **deploy** (pull + redémarrage compose via SSH).
3. Sur Docker Hub : nouvelle image `mlops-redwine:<HASH>`.
4. Sur la VM :

```bash
ssh -i key.pem azureuser@IP
docker ps  # conteneurs up-to-date
```

---

## 7. CHEAT‑SHEET « COPIER‑COLLER »

```bash
# 1. Arrêter proprement
cd /home/azureuser/mlops-redwine
docker-compose down

# 2. Tout réinitialiser
docker-compose down -v
docker system prune -af --volumes

# 3. Redémarrer après nouvelle image
docker-compose pull
docker-compose up -d

# 4. Vérifier
docker ps
```

---

### FÉLICITATIONS 

* Les **secrets** sont créés.
* Le **workflow** se déclenche dès un `git push`.
* Les conteneurs se mettent à jour automatiquement sur votre VM.
