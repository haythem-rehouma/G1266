# ARRÊT COMPLET DU PROJET **mlops-redwine**

*(et préparation à une pipeline CI/CD GitHub Actions → Docker Hub → VM)*

> **Important :** chaque étape est numérotée et **autonome**.
> Copiez‑collez exactement les commandes. Rien n’est laissé à deviner.

---

## PARTIE A – ÉTEINDRE PROPREMENT LE STACK DOCKER

### 1. Se connecter à la VM

```bash
ssh -i key.pem azureuser@IP_PUBLIQUE
```

### 2. Aller dans le dossier du projet

```bash
cd /home/azureuser/mlops-redwine
pwd        # DOIT afficher /home/azureuser/mlops-redwine
```

### 3. Arrêter les conteneurs en conservant les volumes

```bash
docker-compose down
```

### 4. (Facultatif) Supprimer aussi les volumes **pour tout remettre à zéro**

```bash
docker-compose down -v      # efface mlruns + PostgreSQL + pgAdmin
```

### 5. Vérifier qu’il ne reste plus de conteneurs

```bash
docker ps -a                # ne doit rien afficher lié à mlops-redwine
```

### 6. Nettoyer les images et couches inutiles (optionnel mais recommandé)

```bash
docker system prune -af --volumes
```

> **Le projet est maintenant totalement éteint.**
> Vous pouvez fermer la session SSH (`exit`).

---

## PARTIE B – MISE EN PLACE D’UNE PIPELINE CI/CD

### ╔════════════════════════════════ ASCII : Vue d’ensemble ═══════════════════════════════╗

```
 Développeur ──push──▶ GitHub Repo ──GitHub Actions──▶ Docker Hub ──pull──▶ VM Azure
    |                                 (build &                                    │
    └─────────────── SSH ───────────── push) ◀─────────── webhooks ────────────────┘
```

╚════════════════════════════════════════════════════════════════════════════════════════╝

### 1. Prérequis comptes

1.1 Créez (ou utilisez) un compte **GitHub**.
1.2 Créez (ou utilisez) un compte **Docker Hub**. Retenez :
    – *NAMESPACE* : `votre_dockerhub`
    – *REPOSITORY* : `mlops-redwine`

### 2. Initialiser le dépôt Git local

```bash
cd /home/azureuser/mlops-redwine
git init
git add .
git commit -m "Initial commit – stack MLOps"
git branch -M main
git remote add origin https://github.com/<votre_user>/mlops-redwine.git
git push -u origin main
```

*(remplacez `<votre_user>` par votre pseudo GitHub)*

### 3. Créer les **secrets** GitHub nécessaires

Dans **GitHub → Settings → Secrets → Actions** :

| Nom du secret        | Valeur                                               |
| -------------------- | ---------------------------------------------------- |
| `DOCKERHUB_USERNAME` | votre identifiant Docker Hub                         |
| `DOCKERHUB_PASSWORD` | un **Access Token** Docker Hub (pas le mot de passe) |
| `SSH_HOST`           | IP publique de la VM                                 |
| `SSH_USER`           | `azureuser`                                          |
| `SSH_KEY`            | contenu de `key.pem` (clé privée)                    |

> Pour créer l’Access Token : Docker Hub ► **Account Settings** ► **Security** ► **New Access Token** (scopes : `Write`).

### 4. Ajouter le workflow GitHub Actions

Créez `.github/workflows/ci-cd.yml` :

```yaml
name: CI‑CD Docker

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-redwine:${{ steps.vars.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Pull & restart on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/azureuser/mlops-redwine
            docker-compose down
            docker-compose pull
            docker-compose up -d
```

### 5. Committer le workflow

```bash
git add .github/workflows/ci-cd.yml
git commit -m "feat: pipeline CI/CD GitHub Actions → Docker Hub → VM"
git push
```

### 6. Observer la pipeline

* GitHub → **Actions** : le job `CI‑CD Docker` doit passer vert.
* Docker Hub : nouvelle image `mlops-redwine:<hash>` apparaît.
* VM Azure : `docker ps` montre des conteneurs redémarrés avec la nouvelle image.

---

## RÉCAPITULATIF DES COMMANDES « COPIER‑COLLER » POUR LES ÉTUDIANTS

### Arrêt simple

```bash
cd /home/azureuser/mlops-redwine
docker-compose down
```

### Arrêt + reset complet

```bash
cd /home/azureuser/mlops-redwine
docker-compose down -v
docker system prune -af --volumes
```

### Redémarrage après déploiement CI/CD

```bash
cd /home/azureuser/mlops-redwine
docker-compose pull
docker-compose up -d
```

---

## CONTRÔLE FINAL

1. **Streamlit** : `http://IP_VM:8501` répond.
2. **MLflow** : `http://IP_VM:5000` affiche les expériences.
3. **API** :

```bash
curl http://IP_VM:8000/docs   # Swagger interactif
```

4. **Pipeline** : chaque `git push` lance automatiquement : build → push image → redéploiement VM.

> Votre stack est **éteignable** en deux lignes, **redéployable** en un push, et entièrement pilotable depuis Streamlit.
