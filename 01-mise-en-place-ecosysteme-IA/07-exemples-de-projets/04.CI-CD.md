# ARRÃŠT COMPLET DU PROJET **mlops-redwine**

*(et prÃ©paration Ã  une pipeline CI/CD GitHubÂ ActionsÂ â†’Â Dockerâ€¯Hub â†’ VM)*

> **ImportantÂ :** chaque Ã©tape est numÃ©rotÃ©e et **autonome**.
> Copiezâ€‘collez exactement les commandes. Rien nâ€™est laissÃ© Ã  deviner.

---

## PARTIEÂ A â€“ Ã‰TEINDRE PROPREMENT LE STACK DOCKER

### 1. Se connecter Ã  la VM

```bash
ssh -i key.pem azureuser@IP_PUBLIQUE
```

### 2. Aller dans le dossier du projet

```bash
cd /home/azureuser/mlops-redwine
pwd        # DOIT afficher /home/azureuser/mlops-redwine
```

### 3. ArrÃªter les conteneurs en conservant les volumes

```bash
docker-compose down
```

### 4. (Facultatif) Supprimer aussi les volumes **pour tout remettre Ã  zÃ©ro**

```bash
docker-compose down -v      # efface mlruns + PostgreSQL + pgAdmin
```

### 5. VÃ©rifier quâ€™il ne reste plus de conteneurs

```bash
docker ps -a                # ne doit rien afficher liÃ© Ã  mlops-redwine
```

### 6. Nettoyer les images et couches inutiles (optionnel mais recommandÃ©)

```bash
docker system prune -af --volumes
```

> **Le projet est maintenant totalement Ã©teint.**
> Vous pouvez fermer la session SSH (`exit`).

---

## PARTIEÂ B â€“ MISE EN PLACE Dâ€™UNE PIPELINE CI/CD

### â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ASCIIÂ : Vue dâ€™ensemble â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

```
 DÃ©veloppeur â”€â”€pushâ”€â”€â–¶ GitHub Repo â”€â”€GitHubÂ Actionsâ”€â”€â–¶ DockerÂ Hub â”€â”€pullâ”€â”€â–¶ VM Azure
    |                                 (build &                                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ push) â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ webhooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

### 1. PrÃ©requis comptes

1.1 CrÃ©ez (ou utilisez) un compte **GitHub**.
1.2 CrÃ©ez (ou utilisez) un compte **Dockerâ€¯Hub**. Retenezâ€¯:
Â Â Â Â â€“ *NAMESPACE*â€¯: `votre_dockerhub`
Â Â Â Â â€“ *REPOSITORY*â€¯: `mlops-redwine`

### 2. Initialiser le dÃ©pÃ´t Git local

```bash
cd /home/azureuser/mlops-redwine
git init
git add .
git commit -m "Initial commit â€“ stack MLOps"
git branch -M main
git remote add origin https://github.com/<votre_user>/mlops-redwine.git
git push -u origin main
```

*(remplacez `<votre_user>` par votre pseudo GitHub)*

### 3. CrÃ©er les **secrets** GitHub nÃ©cessaires

Dans **GitHub â†’ Settings â†’ Secrets â†’ Actions**â€¯:

| Nom du secret        | Valeur                                               |
| -------------------- | ---------------------------------------------------- |
| `DOCKERHUB_USERNAME` | votre identifiant Dockerâ€¯Hub                         |
| `DOCKERHUB_PASSWORD` | un **Access Token** Dockerâ€¯Hub (pas le mot de passe) |
| `SSH_HOST`           | IP publique de la VM                                 |
| `SSH_USER`           | `azureuser`                                          |
| `SSH_KEY`            | contenu de `key.pem` (clÃ© privÃ©e)                    |

> Pour crÃ©er lâ€™AccessÂ Tokenâ€¯: Dockerâ€¯Hub â–º **AccountÂ Settings** â–º **Security** â–º **NewÂ AccessÂ Token** (scopesÂ : `Write`).

### 4. Ajouter le workflow GitHubÂ Actions

CrÃ©ez `.github/workflows/ci-cd.yml`â€¯:

```yaml
name: CIâ€‘CD Docker

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-redwine:${{ steps.vars.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Pull & restart on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/azureuser/mlops-redwine
            docker-compose down
            docker-compose pull
            docker-compose up -d
```

### 5. Committer le workflow

```bash
git add .github/workflows/ci-cd.yml
git commit -m "feat: pipeline CI/CD GitHubâ€¯Actions â†’ DockerÂ Hub â†’ VM"
git push
```

### 6. Observer la pipeline

* GitHubÂ â†’ **Actions**Â : le job `CIâ€‘CD Docker` doit passer vert.
* Dockerâ€¯HubÂ : nouvelle image `mlops-redwine:<hash>` apparaÃ®t.
* VMÂ AzureÂ : `docker ps` montre des conteneurs redÃ©marrÃ©s avec la nouvelle image.

---

## RÃ‰CAPITULATIF DES COMMANDES Â«Â COPIERâ€‘COLLERÂ Â» POUR LES Ã‰TUDIANTS

### ArrÃªt simple

```bash
cd /home/azureuser/mlops-redwine
docker-compose down
```

### ArrÃªt + reset complet

```bash
cd /home/azureuser/mlops-redwine
docker-compose down -v
docker system prune -af --volumes
```

### RedÃ©marrage aprÃ¨s dÃ©ploiement CI/CD

```bash
cd /home/azureuser/mlops-redwine
docker-compose pull
docker-compose up -d
```

---

## CONTRÃ”LE FINAL

1. **Streamlit**â€¯: `http://IP_VM:8501` rÃ©pond.
2. **MLflow**â€¯: `http://IP_VM:5000` affiche les expÃ©riences.
3. **API**â€¯:

```bash
curl http://IP_VM:8000/docs   # Swagger interactif
```

4. **Pipeline**â€¯: chaque `git push` lance automatiquementâ€¯: build â†’ push image â†’ redÃ©ploiement VM.

> Votre stack est **Ã©teignable** en deux lignes, **redÃ©ployable** en un push, et entiÃ¨rement pilotable depuis Streamlit.




<br/>
<br/>

# Annexe 1 - GUIDE PASâ€‘Ã€â€‘PAS â€“ **CRÃ‰ER LES SECRETS GitHubÂ Actions**



## 1. CONTEXTE RAPIDE

| Secret               | Pourquoi il est nÃ©cessaire                                    |
| -------------------- | ------------------------------------------------------------- |
| `DOCKERHUB_USERNAME` | Pour que GitHub pousse lâ€™image dans **Dockerâ€¯Hub**            |
| `DOCKERHUB_PASSWORD` | (token) â€” authentifie le push                                 |
| `SSH_HOST`           | Adresse IP de la VM pour dÃ©ployer                             |
| `SSH_USER`           | Nom dâ€™utilisateur SSH (ex.Â `azureuser`)                       |
| `SSH_KEY`            | **Contenu texte** de la clÃ© privÃ©eÂ `key.pem` (formatÂ OpenSSH) |

> Les secrets sont Â«â€¯cachÃ©sâ€¯Â»â€¯: personne ne pourra les lire dans les logs GitHubÂ Actions.

---

## 2. ARBORESCENCE DU PROJET (cÃ´tÃ© VMâ€¯/â€¯Git)

```
mlops-redwine/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci-cd.yml          # pipeline Actions
â”œâ”€â”€ api_app.py                 # FastAPI
â”œâ”€â”€ streamlit_app.py           # Streamlit
â”œâ”€â”€ train_model.py             # script d'entraÃ®nement
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ data/
â”‚   â””â”€â”€ red-wine-quality.csv
â””â”€â”€ mlruns/                    # ignorÃ© par Git (.gitignore)
```

**Tous** ces fichiers doivent Ãªtre dÃ©jÃ  dans le dÃ©pÃ´t avant de configurer les secrets.

---

## 3. CRÃ‰ER UN ACCESS TOKEN **Dockerâ€¯Hub** (1Â minute)

1. Connecteâ€‘toi Ã  [https://hub.docker.com](https://hub.docker.com).
2. Avatarâ€¯â–¸ **Account Settings**.
3. Menu gaucheâ€¯: **Security**.
4. Bouton **New Access Token**.
5. Donne un nomâ€¯: `gh-actions`.
6. SÃ©lectionne **Access permissionsâ€¯: Write**.
7. **Generate** â†’ copie le texte affichÃ© **une seule fois** (ex.Â `ghp_xyz...`).

*Gardeâ€‘le en mÃ©moire temporaire, on va le coller dans GitHub Ã  lâ€™Ã©tapeÂ 4.3.*

---

## 4. AJOUTER LES SECRETS DANS GITHUB (interface web)

### 4.1 Ouvrir les paramÃ¨tres

1. Va sur la page GitHub du dÃ©pÃ´t `mlops-redwine`.
2. Clique **Settings** (onglet en haut).

### 4.2 AccÃ©der Ã  la section Actionsâ€¯/â€¯Secrets

1. Colonne gaucheâ€¯: **Secrets and variables**
2. Sousâ€‘menuâ€¯: **Actions**
3. Clique **New repository secret** (bouton vert).

### 4.3 CrÃ©er chaque secret **un par un**

| Clique Â«â€¯Nameâ€¯Â» puis Â«â€¯Valueâ€¯Â» | Exemple de valeur Ã  coller                                                                              |
| ------------------------------ | ------------------------------------------------------------------------------------------------------- |
| `DOCKERHUB_USERNAME`           | **ton identifiant** Dockerâ€¯Hub (ex.Â `monlogin`)                                                         |
| `DOCKERHUB_PASSWORD`           | **token** copiÃ© Ã  lâ€™Ã©tapeÂ 3                                                                             |
| `SSH_HOST`                     | IP publique de la VM (ex.Â `20.123.45.67`)                                                               |
| `SSH_USER`                     | `azureuser`                                                                                             |
| `SSH_KEY`                      | **tout le contenu** de `key.pem` (y compris `-----BEGIN OPENSSH PRIVATE KEY-----` et `-----END â€¦-----`) |

> Pour `SSH_KEY`â€¯:
>
> * Ouvre `key.pem` avec `cat key.pem` ou un Ã©diteur local.
> * Copie **tout** le bloc texte, colleâ€‘le dans la zone Â«â€¯Valueâ€¯Â».
> * Clique **Add secret** Ã  chaque fois.

**RÃ©pÃ¨te** 5Â fois jusquâ€™Ã  voir la liste complÃ¨te des cinq secrets crÃ©Ã©s.

---

## 5. FICHIERS CI/CD (Ã  commit si pas dÃ©jÃ  faits)

### 5.1 RÃ©pertoire et workflow

```bash
cd mlops-redwine
mkdir -p .github/workflows
nano .github/workflows/ci-cd.yml
```

Colle le contenu suivantâ€¯:

```yaml
name: CIâ€‘CD Docker

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build & push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-redwine:${{ steps.vars.outputs.TAG }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/azureuser/mlops-redwine
            docker-compose pull
            docker-compose up -d
```

Enregistre puis ferme (`CTRL+O`, `Enter`, `CTRL+X`).

### 5.2 Commit + push

```bash
git add .github/workflows/ci-cd.yml
git commit -m "chore: add GitHub Actions CI/CD workflow"
git push
```

---

## 6. VÃ‰RIFIER LA PIPELINE

1. GitHubâ€¯â–¸ onglet **Actions**Â â†’â€¯workflow Â«â€¯CIâ€‘CD Dockerâ€¯Â».
2. Observe les deux jobsÂ :

   * **build-and-push** (image envoyÃ©e sur Dockerâ€¯Hub)
   * **deploy** (pull + redÃ©marrage compose via SSH).
3. Sur Dockerâ€¯Hubâ€¯: nouvelle image `mlops-redwine:<HASH>`.
4. Sur la VMâ€¯:

```bash
ssh -i key.pem azureuser@IP
docker ps  # conteneurs up-to-date
```

---

## 7. CHEATâ€‘SHEET Â«Â COPIERâ€‘COLLERÂ Â»

```bash
# 1. ArrÃªter proprement
cd /home/azureuser/mlops-redwine
docker-compose down

# 2. Tout rÃ©initialiser
docker-compose down -v
docker system prune -af --volumes

# 3. RedÃ©marrer aprÃ¨s nouvelle image
docker-compose pull
docker-compose up -d

# 4. VÃ©rifier
docker ps
```

---

### FÃ‰LICITATIONS 

* Les **secrets** sont crÃ©Ã©s.
* Le **workflow** se dÃ©clenche dÃ¨s un `git push`.
* Les conteneurs se mettent Ã  jour automatiquement sur votre VM.



<br/>
<br/>


# Annexe 2


- **la base reste la mÃªme**, mais nous avons ajoutÃ© **trois Ã©lÃ©ments**â€¯:

1. **Des dÃ©pendances en plus** (FastAPI,â€¯Uvicorn,â€¯Streamlit,â€¯git)
2. **Deux nouveaux fichiers**Â : `api_app.py` et `streamlit_app.py`
3. **Deux nouveaux services** dans `dockerâ€‘compose.yml`Â (`api`, `streamlit`)

Tout le reste (dataset,Â `train_model.py`, `mlflow`, `postgres`, `pgadmin`, `portainer`) **est inchangÃ©**.

---

## RÃ©capitulatif complet des fichiers (copierâ€‘coller pour refaire lâ€™arborescence)

```bash
mlops-redwine/
â”œâ”€â”€ Dockerfile               # mÃªme qu'avant + git installÃ©
â”œâ”€â”€ requirements.txt         # mÃªmes libs + fastapi uvicorn streamlit
â”œâ”€â”€ train_model.py           # inchangÃ© (sep=';')
â”œâ”€â”€ api_app.py               # NOUVEAU â€“ FastAPI
â”œâ”€â”€ streamlit_app.py         # NOUVEAU â€“ Streamlit
â”œâ”€â”€ docker-compose.yml       # mlflow + api + streamlit + postgres + pgAdmin + Portainer
â”œâ”€â”€ data/
â”‚   â””â”€â”€ red-wine-quality.csv # dataset
â””â”€â”€ mlruns/                  # artÃ©facts MLflow (volume)
```

---

## Contenu exact de chaque fichier

### 1. `requirements.txt`

```
pandas
numpy
scikit-learn
mlflow
psycopg2-binary
fastapi
uvicorn[standard]
streamlit
```

### 2. `Dockerfile`

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY . .

RUN apt-get update && apt-get install -y git \
 && pip install --upgrade pip \
 && pip install -r requirements.txt \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

CMD ["bash"]
```

### 3. `train_model.py`

*(identique Ã  la version prÃ©cÃ©dente, donc Ã  **reprendre tel quel**).*

### 4. `api_app.py` (FastAPI)

```python
from fastapi import FastAPI
from pydantic import BaseModel
import subprocess, uuid, os

app = FastAPI(title="Redâ€‘Wine MLOps API")

class TrainRequest(BaseModel):
    model: str           # elasticnet | ridge | lasso
    alpha: float
    l1_ratio: float | None = None

@app.post("/train")
def train(req: TrainRequest):
    run_id = str(uuid.uuid4())[:8]
    cmd = ["python", "train_model.py",
           "--model", req.model,
           "--alpha", str(req.alpha)]
    if req.model == "elasticnet":
        cmd += ["--l1_ratio", str(req.l1_ratio or 0.5)]
    env = os.environ.copy()
    env["MLFLOW_TRACKING_URI"] = env.get("MLFLOW_TRACKING_URI", "http://mlflow:5000")
    subprocess.Popen(cmd, env=env)
    return {"status": "started", "run_id": run_id}

class PredictRequest(BaseModel):
    alcohol: float
    volatile_acidity: float
    sulphates: float

@app.post("/predict")
def predict(inp: PredictRequest):
    score = 3 + 0.3*inp.alcohol - 1.2*inp.volatile_acidity + 0.8*inp.sulphates
    return {"quality_estimate": round(score, 2)}
```

### 5. `streamlit_app.py`

```python
import streamlit as st
import requests, json

st.set_page_config(page_title="Redâ€‘Wine Trainer", layout="wide")
st.title("ğŸ· Redâ€‘Wine Trainer â€“ Interface Streamlit")

with st.form("train"):
    model = st.selectbox("ModÃ¨le", ["elasticnet", "ridge", "lasso"])
    alpha = st.slider("alpha", 0.01, 2.0, 0.5, 0.01)
    l1    = st.slider("l1_ratio (ElasticNet uniquement)", 0.0, 1.0, 0.5, 0.05)
    ok = st.form_submit_button("ğŸš€ Lancer")
    if ok:
        payload = {"model": model, "alpha": alpha, "l1_ratio": l1}
        r = requests.post("http://api:8000/train",
                          data=json.dumps(payload),
                          headers={"Content-Type": "application/json"})
        st.success(r.json())

st.header("PrÃ©diction rapide")
a   = st.number_input("Alcohol",  8.0, 15.0, 10.0, 0.1)
va  = st.number_input("Volatile acidity", 0.1, 1.5, 0.5, 0.01)
sul = st.number_input("Sulphates", 0.3, 1.8, 0.8, 0.05)
if st.button("ğŸ”® PrÃ©dire"):
    body = {"alcohol": a, "volatile_acidity": va, "sulphates": sul}
    r = requests.post("http://api:8000/predict",
                      data=json.dumps(body),
                      headers={"Content-Type": "application/json"})
    st.write(r.json())
```

### 6. `docker-compose.yml` (complet)

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:14
    restart: unless-stopped
    environment:
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow
      POSTGRES_DB: mlflow_db
    ports: ["5432:5432"]
    volumes: [postgres_data:/var/lib/postgresql/data]

  mlflow:
    build: .
    restart: unless-stopped
    depends_on: [postgres]
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
    command: >
      mlflow server
      --backend-store-uri postgresql://mlflow:mlflow@postgres:5432/mlflow_db
      --default-artifact-root /app/mlruns
      --host 0.0.0.0
    ports: ["5000:5000"]
    volumes:
      - ./mlruns:/app/mlruns
      - ./data:/app/data

  api:
    build: .
    restart: unless-stopped
    depends_on: [mlflow]
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
    command: uvicorn api_app:app --host 0.0.0.0 --port 8000 --reload
    ports: ["8000:8000"]
    volumes:
      - ./data:/app/data

  streamlit:
    build: .
    restart: unless-stopped
    depends_on: [api]
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
    command: streamlit run streamlit_app.py --server.port 8501 --server.address 0.0.0.0
    ports: ["8501:8501"]
    volumes:
      - ./data:/app/data

  pgadmin:
    image: dpage/pgadmin4
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports: ["8080:80"]
    volumes: [pgadmin_data:/var/lib/pgadmin]

  portainer:
    image: portainer/portainer-ce
    restart: unless-stopped
    command: -H unix:///var/run/docker.sock
    ports: ["9000:9000"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data

volumes:
  postgres_data:
  pgadmin_data:
  portainer_data:
```

---

## Checklist Â«â€¯Copierâ€‘Collerâ€¯Â» pour lâ€™Ã©tudiant

1. **CrÃ©er lâ€™arborescence** avec les 7 fichiers ciâ€‘dessus.
2. TÃ©lÃ©charger le dataset (`data/red-wine-quality.csv`).
3. Lancerâ€¯:

```bash
docker-compose pull
docker-compose build --no-cache mlflow
docker-compose up -d
```

4. OuvrirÂ :

* StreamlitÂ : `http://IP:8501`
* MLflowÂ : `http://IP:5000`
* Swagger FastAPIÂ : `http://IP:8000/docs`



<br/>
<br/>

# Annexe 3 - tester la pipeline


- Nous allons apporter une petite modification, par exemple dans le fichier `train_model.py` ou `streamlit.py`, comme changer un message de print. Ensuite, fais un commit avec un message explicite, et pousse la branche ou directement Ã  `main`. Ce processus dÃ©clenchera le pipeline CI/CD qui construira l'image Docker, la pousser Ã  Docker Hub et la dÃ©ploiera sur ta machine virtuelle.




### DÃ‰MO CIâ€‘CD **EN CONDITIONS RÃ‰ELLES** â€” PASâ€‘Ã€â€‘PAS ULTRAÂ DÃ‰BUTANT

*(dÃ©clencher la pipeline, vÃ©rifier le dÃ©ploiement, sans rien deviner)*

---

## SITUATION DE DÃ‰PART

* Le projet **mlopsâ€‘redwine** est dÃ©jÃ  dans GitHub **et** sur la VM.
* Les **secrets GitHub** (`DOCKERHUB_USERNAME`, `â€¦`) sont crÃ©Ã©s.
* Le workflow `.github/workflows/ci-cd.yml` existe.
* Les conteneurs tournent sur la VM (`docker ps` â†’ 6â€¯services Â«â€¯Upâ€¯Â»).

Nous allons **modifier** une ligne dans `train_model.py`, **pousser** sur *main*, et regarder le pipeline :

1. **build** lâ€™image
2. **push** sur Dockerâ€¯Hub
3. **SSHâ€‘deploy** (composeÂ pull + upâ€¯â€‘d) sur la VM.

---

## Ã‰TAPES 1â€‘2â€‘3Â : FAIRE UNE PETITE MODIF & GITÂ PUSH

> **Choix**Â : vous pouvez travailler **sur votre machine locale** OU **directement sur la VM**.
> Ici on montre la mÃ©thode Â«â€¯VMâ€¯Â» (la plus simple pour un dÃ©butant).

### 1. Se connecter Ã  la VM & aller dans le projet

```bash
ssh -i key.pem azureuser@IP_PUBLIQUE
cd /home/azureuser/mlops-redwine
pwd      # doit afficher /home/azureuser/mlops-redwine
```

### 2. Faire une miniâ€‘modification (exemple : message print)

```bash
nano train_model.py
```

*Chercher la toute fin du fichier (`CTRL+V` plusieurs fois) et trouvezâ€¯:*

```python
print(f"TerminÃ© : {args.model}  alpha={args.alpha}")
```

*Remplacez par â€”â€¯ligne exacteÂ :*

```python
print(f"âœ”ï¸  Run terminÃ© â€” modÃ¨le={args.model} | alpha={args.alpha}")
```

*SauvegarderÂ : `CTRL+O` â†’ `Enter`, quitterÂ : `CTRL+X`.*

### 3. Commit & push **sur la brancheâ€¯main**

```bash
git add train_model.py
git commit -m "feat: new success emoji message"
git push origin main
```

---

## Ã‰TAPEÂ 4Â : OBSERVER LA PIPELINE SUR GITHUB

1. Ouvrir le dÃ©pÃ´t dans le navigateur
2. Cliquer sur **Actions** â†’ workflow nommÃ© **CIâ€‘CD Docker**
3. Voir deux jobsÂ : `build-and-push` puis `deploy`.

*Attendre leur statut **ğŸŸ¢â€¯green** (â‰ˆâ€¯2â€¯â€“â€¯4â€¯min).*

> AstuceÂ : la **balise dâ€™image** poussÃ©e est le hash Git (`abcdef12`).

---

## Ã‰TAPEÂ 5Â : VÃ‰RIFIER LE DÃ‰PLOIEMENT SUR LA VM

### 5.1 VÃ©rifier que les conteneurs ont redÃ©marrÃ©

```bash
ssh -i key.pem azureuser@IP_PUBLIQUE
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.RunningFor}}"
```

Vous devriez voir lâ€™image **`docker.io/<dockerhub>/mlops-redwine:abcdef12`** (le mÃªme hash que dans GitHub).

### 5.2 Confirmer le nouveau message dans les logs

```bash
cd /home/azureuser/mlops-redwine
docker-compose logs -n 20 mlflow
```

*Ligne attendue (nouveau texte avec emoji)Â :*

```
âœ”ï¸  Run terminÃ© â€” modÃ¨le=ridge | alpha=0.7
```

### 5.3 VÃ©rifier API / Streamlit tournent toujours

* `http://IP_PUBLIQUE:8000/docs` sâ€™ouvre
* `http://IP_PUBLIQUE:8501` montre Streamlit

---

## SYNTHÃˆSE Â«â€¯QUE DOIT FAIRE Lâ€™Ã‰TUDIANTâ€¯Â» (copierâ€‘coller)

```bash
# 0. Ouvrir SSH et cd projet
ssh -i key.pem azureuser@IP
cd /home/azureuser/mlops-redwine

# 1. Ã‰diter un fichier
nano train_model.py        # changer un print ou n'importe quoi
#   CTRL+O, Enter, CTRL+X pour sauver

# 2. Commit + push
git add train_model.py
git commit -m "mon premier changement"
git push origin main

# 3. Sur GitHub > Actions : attendre le âœ… vert

# 4. Sur la VM : vÃ©rifier
docker ps                # image tag = nouveau hash
docker-compose logs mlflow | tail
```

---

## SI BESOIN DE REâ€‘DÃ‰MARRER MANUELLEMENT

```bash
cd /home/azureuser/mlops-redwine
docker-compose pull
docker-compose up -d
```

---

### âœâ€¯Vous avez maintenant vu **en vrai**â€¯:

1. Un **changement de code**
2. Un **push Git**
3. Une **pipeline GitHubÂ Actions** automatique
4. Le **dÃ©ploiement** instantanÃ© sur la VM without manual SSHâ€‘copy.
